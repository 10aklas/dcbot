<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORLEQTOR - Anonymous P2P Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --background: #121212;
            --surface: #1e1e1e;
            --primary: #bb86fc;
            --secondary: #03dac6;
            --text: #e0e0e0;
            --text-secondary: #a0a0a0;
            --error: #cf6679;
            --success: #4caf50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background-color: var(--surface);
            padding: 1rem 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .tagline {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .user-info {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
        }
        
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            text-align: center;
        }
        
        .buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
        }
        
        .btn {
            background-color: var(--surface);
            color: var(--text);
            border: 2px solid var(--primary);
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
        }
        
        .btn:hover {
            background-color: var(--primary);
            color: var(--background);
            transform: translateY(-3px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            min-width: auto;
        }
        
        .friend-code-container {
            display: none;
            margin-top: 2rem;
            background-color: var(--surface);
            padding: 1rem 2rem;
            border-radius: 8px;
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        
        .code-display {
            font-size: 1.5rem;
            color: var(--secondary);
            background-color: rgba(3, 218, 198, 0.1);
            padding: 0.5rem;
            border-radius: 4px;
            margin: 1rem 0;
            user-select: all;
        }
        
        .join-code-container {
            display: none;
            margin-top: 2rem;
            background-color: var(--surface);
            padding: 1rem 2rem;
            border-radius: 8px;
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        
        .code-input {
            width: 100%;
            padding: 0.5rem 1rem;
            font-size: 1.2rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--secondary);
            border-radius: 4px;
            color: var(--text);
            margin: 1rem 0;
        }
        
        .loading-container {
            display: none;
            margin-top: 2rem;
            text-align: center;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1rem;
        }
        
        .chat-container {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        .chat-header {
            background-color: var(--surface);
            padding: 1rem;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .partner-name {
            font-weight: bold;
        }
        
        .connection-status {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: var(--error);
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-indicator.connected {
            background-color: var(--success);
        }
        
        .end-chat-btn {
            background-color: var(--error);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .messages {
            flex: 1;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            overflow-y: auto;
            height: 50vh;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .message-container {
            display: flex;
            flex-direction: column;
        }
        
        .message-container.sent {
            align-items: flex-end;
        }
        
        .message-container.received {
            align-items: flex-start;
        }
        
        .message-header {
            font-size: 0.8rem;
            margin-bottom: 2px;
            color: var(--text-secondary);
            padding: 0 0.5rem;
        }
        
        .message {
            max-width: 70%;
            padding: 0.5rem 1rem;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message.received {
            background-color: var(--surface);
            border-bottom-left-radius: 4px;
        }
        
        .message.sent {
            background-color: var(--primary);
            color: var(--background);
            border-bottom-right-radius: 4px;
        }
        
        .system-message {
            text-align: center;
            color: var(--text-secondary);
            margin: 0.5rem 0;
            font-style: italic;
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        .input-area {
            background-color: var(--surface);
            padding: 1rem;
            border-radius: 0 0 8px 8px;
            display: flex;
            gap: 0.5rem;
        }
        
        .message-input {
            flex: 1;
            padding: 0.8rem;
            border-radius: 4px;
            border: none;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text);
            font-size: 1rem;
        }
        
        .message-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(187, 134, 252, 0.3);
        }
        
        .send-btn {
            background-color: var(--secondary);
            color: var(--background);
            border: none;
            border-radius: 4px;
            padding: 0 1.5rem;
            cursor: pointer;
            font-weight: bold;
        }
        
        .send-btn:disabled {
            background-color: rgba(3, 218, 198, 0.3);
            cursor: not-allowed;
        }
        
        .typing-indicator {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 0.5rem;
            height: 1rem;
        }
        
        .disclaimer {
            margin-top: 2rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-align: center;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: var(--surface);
            color: var(--text);
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            animation: slide-in 0.3s ease-out;
        }
        
        @keyframes slide-in {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        @media (max-width: 768px) {
            .buttons {
                flex-direction: column;
            }
            
            main {
                padding: 1rem;
            }
            
            .message {
                max-width: 85%;
            }
            
            .user-info {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    
    <header>
        <h1>ORLEQTOR</h1>
        <p class="tagline">100% Anonymous P2P Chat</p>
        <div id="user-info" class="user-info">
            <div id="user-avatar" class="user-avatar"></div>
            <span id="username">Generating username...</span>
        </div>
    </header>
    
    <main>
        <div class="welcome-screen">
            <h2>Start a secure, anonymous conversation</h2>
            <p>All messages are sent peer-to-peer with no server storage</p>
            
            <div class="buttons">
                <button id="chat-stranger-btn" class="btn">Chat with Stranger</button>
                <button id="chat-friend-btn" class="btn">Chat with Friend</button>
                <button id="join-friend-btn" class="btn">Join with Code</button>
            </div>
            
            <div id="friend-code-container" class="friend-code-container">
                <h3>Share this code with your friend</h3>
                <div id="friend-code" class="code-display">Generating code...</div>
                <p>Your friend can use this code to join your chat room</p>
                <button id="copy-code-btn" class="btn btn-small">Copy Code</button>
                <p id="waiting-message">Waiting for friend to connect...</p>
            </div>
            
            <div id="join-code-container" class="join-code-container">
                <h3>Enter your friend's code</h3>
                <input type="text" id="code-input" class="code-input" placeholder="Enter 16-character code" maxlength="16">
                <button id="connect-btn" class="btn btn-small">Connect</button>
            </div>
            
            <div id="loading-container" class="loading-container">
                <div class="loading-spinner"></div>
                <p id="loading-text" class="loading-text">Looking for a stranger to chat with...</p>
            </div>
            
            <p class="disclaimer">
                ORLEQTOR uses peer-to-peer technology to ensure your conversations remain private.
                No messages are stored on any servers. Your randomly generated username changes
                each time you reload the page for complete anonymity.
            </p>
        </div>
        
        <div id="chat-container" class="chat-container">
            <div class="chat-header">
                <div class="chat-info">
                    <span id="status-indicator" class="status-indicator"></span>
                    <span id="partner-name" class="partner-name">Unknown</span>
                    <span id="connection-status" class="connection-status">Connecting...</span>
                </div>
                <button id="end-chat-btn" class="end-chat-btn">End Chat</button>
            </div>
            <div id="messages" class="messages"></div>
            <div class="typing-indicator" id="typing-indicator"></div>
            <div class="input-area">
                <input type="text" id="message-input" class="message-input" placeholder="Type your message..." disabled>
                <button id="send-btn" class="send-btn" disabled>Send</button>
            </div>
        </div>
    </main>
    
    <script>
        // DOM Elements
        const welcomeScreen = document.querySelector('.welcome-screen');
        const chatContainer = document.getElementById('chat-container');
        const chatStrangerBtn = document.getElementById('chat-stranger-btn');
        const chatFriendBtn = document.getElementById('chat-friend-btn');
        const joinFriendBtn = document.getElementById('join-friend-btn');
        const friendCodeContainer = document.getElementById('friend-code-container');
        const friendCode = document.getElementById('friend-code');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const joinCodeContainer = document.getElementById('join-code-container');
        const codeInput = document.getElementById('code-input');
        const connectBtn = document.getElementById('connect-btn');
        const loadingContainer = document.getElementById('loading-container');
        const loadingText = document.getElementById('loading-text');
        const endChatBtn = document.getElementById('end-chat-btn');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const connectionStatus = document.getElementById('connection-status');
        const partnerName = document.getElementById('partner-name');
        const waitingMessage = document.getElementById('waiting-message');
        const usernameDisplay = document.getElementById('username');
        const userAvatar = document.getElementById('user-avatar');
        const notification = document.getElementById('notification');
        const typingIndicator = document.getElementById('typing-indicator');
        
        // Global variables
        let peer = null;
        let connection = null;
        let myPeerId = null;
        let myUsername = '';
        let partnerUsername = '';
        let waitingForStranger = false;
        let typingTimeout = null;
        let lastTypingSignal = 0;
        let isTyping = false;
        
        // Generate a random username
        function generateUsername() {
            const adjectives = ["Swift", "Crimson", "Azure", "Golden", "Silver", "Cosmic", "Mystic", "Phantom", "Shadow", "Neon", "Cyber", "Quantum", "Echo", "Nova", "Alpha", "Omega", "Frost", "Phoenix", "Vortex", "Digital", "Crystal", "Onyx", "Sapphire", "Emerald", "Ruby", "Obsidian", "Jade", "Amber", "Coral", "Aqua"];
            const nouns = ["Raven", "Wolf", "Fox", "Hawk", "Eagle", "Tiger", "Dragon", "Lion", "Panther", "Falcon", "Serpent", "Knight", "Ranger", "Hunter", "Ghost", "Specter", "Wraith", "Voyager", "Crusader", "Guardian", "Sentinel", "Nomad", "Wanderer", "Warden", "Pioneer", "Ninja", "Samurai", "Ronin", "Titan", "Oracle"];
            
            const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const number = Math.floor(Math.random() * 1000);
            
            return `${adjective}${noun}${number}`;
        }
        
        // Generate avatar initial and color
        function generateAvatar(username) {
            userAvatar.textContent = username.charAt(0);
            
            // Generate a deterministic color based on username
            const hash = CryptoJS.MD5(username).toString();
            const hue = parseInt(hash.substring(0, 6), 16) % 360;
            userAvatar.style.backgroundColor = `hsl(${hue}, 70%, 60%)`;
        }
        
        // Initialize PeerJS
        function initializePeer() {
            // Create a random ID to ensure anonymity
            const randomId = generateRandomId(32);
            
            // Generate a random username
            myUsername = generateUsername();
            usernameDisplay.textContent = myUsername;
            generateAvatar(myUsername);
            
            // Create peer connection
            peer = new Peer(randomId, {
                debug: 2,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', (id) => {
                myPeerId = id;
                console.log('My peer ID is: ' + id);
            });
            
            peer.on('connection', (conn) => {
                if (connection) {
                    // Already connected, reject new connection
                    conn.close();
                    return;
                }
                
                connection = conn;
                setupConnectionListeners();
                
                // If we're waiting for a stranger, we're now connected
                if (waitingForStranger) {
                    waitingForStranger = false;
                    hideElement(loadingContainer);
                }
                
                showChatInterface();
            });
            
            peer.on('error', (err) => {
                console.error('PeerJS error:', err);
                showNotification('Connection error: ' + err.message);
                resetChat();
            });
        }
        
        // Generate a random ID with specified length
        function generateRandomId(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Generate a 16-character code for friend chat
        function generateFriendCode() {
            return generateRandomId(16);
        }
        
        // Setup connection listeners
        function setupConnectionListeners() {
            connection.on('open', () => {
                // Send my username to partner
                sendMetadata({ type: 'username', username: myUsername });
                
                connectionStatus.textContent = 'Connected';
                statusIndicator.classList.add('connected');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
                
                // Hide waiting message if this was a friend code connection
                hideElement(waitingMessage);
            });
            
            connection.on('data', (data) => {
                if (typeof data === 'object' && data !== null) {
                    handleMetadata(data);
                } else {
                    addMessage(data, 'received');
                }
            });
            
            connection.on('close', () => {
                addSystemMessage('Your chat partner has disconnected.');
                resetChatInterface();
            });
            
            connection.on('error', (err) => {
                console.error('Connection error:', err);
                addSystemMessage('Connection error. Please try again.');
                resetChat();
            });
        }
        
        // Handle metadata messages
        function handleMetadata(data) {
            switch (data.type) {
                case 'username':
                    partnerUsername = data.username;
                    partnerName.textContent = partnerUsername;
                    addSystemMessage(`You are now chatting with ${partnerUsername}`);
                    break;
                case 'typing':
                    if (data.isTyping) {
                        typingIndicator.textContent = `${partnerUsername} is typing...`;
                    } else {
                        typingIndicator.textContent = '';
                    }
                    break;
            }
        }
        
        // Send metadata messages
        function sendMetadata(data) {
            if (connection && connection.open) {
                connection.send(data);
            }
        }
        
        // Add a message to the chat
        function addMessage(text, type) {
            const container = document.createElement('div');
            container.classList.add('message-container', type);
            
            const header = document.createElement('div');
            header.classList.add('message-header');
            header.textContent = type === 'sent' ? myUsername : partnerUsername;
            
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', type);
            messageElement.textContent = text;
            
            container.appendChild(header);
            container.appendChild(messageElement);
            messagesContainer.appendChild(container);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Add a system message
        function addSystemMessage(text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('system-message');
            messageElement.textContent = text;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Show notification
        function showNotification(message) {
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Show/hide elements
        function showElement(element) {
            element.style.display = element.tagName === 'DIV' ? 'flex' : 'block';
        }
        
        function hideElement(element) {
            element.style.display = 'none';
        }
        
        // Show the chat interface
        function showChatInterface() {
            hideElement(welcomeScreen);
            showElement(chatContainer);
        }
        
        // Reset the chat interface
        function resetChatInterface() {
            connectionStatus.textContent = 'Disconnected';
            statusIndicator.classList.remove('connected');
            messageInput.disabled = true;
            sendBtn.disabled = true;
            typingIndicator.textContent = '';
        }
        
        // Reset the entire chat and return to welcome screen
        function resetChat() {
            if (connection) {
                connection.close();
                connection = null;
            }
            
            waitingForStranger = false;
            partnerUsername = '';
            partnerName.textContent = 'Unknown';
            
            // Clear messages
            messagesContainer.innerHTML = '';
            
            // Reset UI
            hideElement(chatContainer);
            showElement(welcomeScreen);
            hideElement(friendCodeContainer);
            hideElement(joinCodeContainer);
            hideElement(loadingContainer);
            resetChatInterface();
        }
        
        // Handle typing indicator
        function handleTyping() {
            if (!isTyping) {
                isTyping = true;
                sendMetadata({ type: 'typing', isTyping: true });
            }
            
            clearTimeout(typingTimeout);
            
            typingTimeout = setTimeout(() => {
                isTyping = false;
                sendMetadata({ type: 'typing', isTyping: false });
            }, 1000);
        }
        
        // Simple signaling server simulation for stranger chat
        // In a real application, this would be a proper signaling server
        let waitingPeers = [];
        
        function findStrangerChat() {
            loadingText.textContent = 'Looking for a stranger to chat with...';
            showElement(loadingContainer);
            
            // Simulate finding a peer
            // In a real app, this would involve communicating with a server
            setTimeout(() => {
                if (waitingForStranger) {
                    // Simulate finding a peer after a random delay
                    const randomPeerId = generateRandomId(32);
                    simulateStrangerConnection(randomPeerId);
                }
            }, 2000 + Math.random() * 3000);
        }
        
        function simulateStrangerConnection(peerId) {
            if (!waitingForStranger) return;
            
            loadingText.textContent = 'Found someone! Connecting...';
            
            // Simulate connection
            setTimeout(() => {
                if (!waitingForStranger) return;
                
                // Create simulated connection
                connection = {
                    open: true,
                    send: (data) => {
                        setTimeout(() => {
                            // Echo back for demonstration
                            if (typeof data === 'object' && data !== null) {
                                if (data.type === 'username') {
                                    // Simulate receiving partner's username
                                    partnerUsername = generateUsername();
                                    partnerName.textContent = partnerUsername;
                                    addSystemMessage(`You are now chatting with ${partnerUsername}`);
                                } else if (data.type === 'typing') {
                                    // Simulate typing indicator
                                    if (data.isTyping && Math.random() > 0.7) {
                                        typingIndicator.textContent = `${partnerUsername} is typing...`;
                                        setTimeout(() => {
                                            typingIndicator.textContent = '';
                                        }, 2000);
                                    }
                                }
                            } else {
                                // Simulate response after a delay
                                if (Math.random() > 0.3) {
                                    setTimeout(() => {
                                        addMessage(`This is a simulated response to: "${data}"`, 'received');
                                    }, 1000 + Math.random() * 3000);
                                }
                            }
                        }, 100);
                    },
                    close: () => {
                        console.log('Connection closed');
                    },
                    on: (event, callback) => {
                        if (event === 'open') {
                            callback();
                        }
                    }
                };
                
                waitingForStranger = false;
                hideElement(loadingContainer);
                showChatInterface();
                
                // Send my username
                sendMetadata({ type: 'username', username: myUsername });
                
                connectionStatus.textContent = 'Connected';
                statusIndicator.classList.add('connected');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
            }, 1500);
        }
        
        // Simulate friend code connection
        function simulateFriendConnection(code) {
            // In a real app, this would connect to a specific peer using the code
            setTimeout(() => {
                // Create simulated connection
                connection = {
                    open: true,
                    send: (data) => {
                        setTimeout(() => {
                            // Echo back for demonstration
                            if (typeof data === 'object' && data !== null) {
                                if (data.type === 'username') {
                                    // Simulate receiving partner's username
                                    partnerUsername = generateUsername();
                                    partnerName.textContent = partnerUsername;
                                    addSystemMessage(`You are now chatting with ${partnerUsername}`);
                                } else if (data.type === 'typing') {
                                    // Simulate typing indicator
                                    if (data.isTyping && Math.random() > 0.7) {
                                        typingIndicator.textContent = `${partnerUsername} is typing...`;
                                        setTimeout(() => {
                                            typingIndicator.textContent = '';
                                        }, 2000);
                                    }
                                }
                            } else {
                                // Simulate response after a delay
                                if (Math.random() > 0.3) {
                                    setTimeout(() => {
                                        addMessage(`This is a simulated response using code: ${code}`, 'received');
                                    }, 1000 + Math.random() * 3000);
                                }
                            }
                        }, 100);
                    },
                    close: () => {
                        console.log('Connection closed');
                    },
                    on: (event, callback) => {
                        if (event === 'open') {
                            callback();
                        }
                    }
                };
                
                showChatInterface();
                
                // Send my username
                sendMetadata({ type: 'username', username: myUsername });
                connectionStatus.textContent = 'Connected';
                statusIndicator.classList.add('connected');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
            }, 1500);
        }
        
        // Wait for a connection with the given code
        function waitForConnection(code) {
            waitingMessage.textContent = `Waiting for someone to connect with code: ${code}`;
            showElement(waitingMessage);
            
            // Simulate incoming connection after random delay
            setTimeout(() => {
                // Create simulated connection
                connection = {
                    open: true,
                    send: (data) => {
                        setTimeout(() => {
                            // Echo back for demonstration
                            if (typeof data === 'object' && data !== null) {
                                if (data.type === 'username') {
                                    // Simulate receiving partner's username
                                    partnerUsername = generateUsername();
                                    partnerName.textContent = partnerUsername;
                                    addSystemMessage(`You are now chatting with ${partnerUsername}`);
                                } else if (data.type === 'typing') {
                                    // Simulate typing indicator
                                    if (data.isTyping && Math.random() > 0.7) {
                                        typingIndicator.textContent = `${partnerUsername} is typing...`;
                                        setTimeout(() => {
                                            typingIndicator.textContent = '';
                                        }, 2000);
                                    }
                                }
                            } else {
                                // Simulate response after a delay
                                if (Math.random() > 0.3) {
                                    setTimeout(() => {
                                        addMessage(`This is a simulated response to: "${data}"`, 'received');
                                    }, 1000 + Math.random() * 3000);
                                }
                            }
                        }, 100);
                    },
                    close: () => {
                        console.log('Connection closed');
                    },
                    on: (event, callback) => {
                        if (event === 'open') {
                            callback();
                        }
                    }
                };
                
                showChatInterface();
                
                // Send my username
                sendMetadata({ type: 'username', username: myUsername });
                
                connectionStatus.textContent = 'Connected';
                statusIndicator.classList.add('connected');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
                
                hideElement(waitingMessage);
            }, 3000 + Math.random() * 5000);
        }
        
        // Initialize the application
        function init() {
            initializePeer();
            
            // Event: Chat with stranger
            chatStrangerBtn.addEventListener('click', () => {
                waitingForStranger = true;
                findStrangerChat();
            });
            
            // Event: Chat with friend (create a room)
            chatFriendBtn.addEventListener('click', () => {
                const code = generateFriendCode();
                friendCode.textContent = code;
                showElement(friendCodeContainer);
                hideElement(joinCodeContainer);
                showElement(waitingMessage);
                
                // Wait for someone to connect with this code
                waitForConnection(code);
            });
            
            // Event: Join with code
            joinFriendBtn.addEventListener('click', () => {
                showElement(joinCodeContainer);
                hideElement(friendCodeContainer);
            });
            
            // Event: Copy friend code
            copyCodeBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(friendCode.textContent)
                    .then(() => {
                        const originalText = copyCodeBtn.textContent;
                        copyCodeBtn.textContent = 'Copied!';
                        setTimeout(() => {
                            copyCodeBtn.textContent = originalText;
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
            });
            
            // Event: Connect using friend code
            connectBtn.addEventListener('click', () => {
                const code = codeInput.value.trim();
                if (code.length !== 16) {
                    showNotification('Please enter a valid 16-character code');
                    return;
                }
                
                addSystemMessage('Connecting to your friend...');
                showChatInterface();
                
                // Simulate connection using the code
                simulateFriendConnection(code);
            });
            
            // Event: Send message
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Event: Handle typing indicator
            messageInput.addEventListener('input', handleTyping);
            
            // Event: End chat
            endChatBtn.addEventListener('click', () => {
                addSystemMessage('You ended the chat.');
                resetChat();
            });
            
            // Prevent accidental navigation
            window.addEventListener('beforeunload', (e) => {
                if (connection) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });
        }
        
        // Send a message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            addMessage(message, 'sent');
            
            if (connection && connection.open) {
                connection.send(message);
            }
            
            messageInput.value = '';
            messageInput.focus();
            
            // Reset typing indicator
            if (isTyping) {
                isTyping = false;
                sendMetadata({ type: 'typing', isTyping: false });
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
        
        // Handle offline/online status
        window.addEventListener('online', () => {
            showNotification('You are back online');
        });
        
        window.addEventListener('offline', () => {
            showNotification('You are offline. Connection may be limited.');
        });
        
        // Auto-reconnect when page regains focus
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && peer && !connection) {
                console.log("Page is visible again, checking peer status...");
                if (peer.disconnected) {
                    console.log("Reconnecting peer...");
                    peer.reconnect();
                }
            }
        });
    </script>
</body>
</html>
